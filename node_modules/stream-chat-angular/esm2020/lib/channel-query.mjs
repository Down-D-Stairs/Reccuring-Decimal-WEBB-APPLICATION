/**
 * This class allows you to make paginated channel query requests.
 */
export class ChannelQuery {
    constructor(chatService, channelService, filters, sort = { last_message_at: -1 }, options = {
        limit: 25,
        state: true,
        presence: true,
        watch: true,
    }) {
        this.chatService = chatService;
        this.channelService = channelService;
        this.filters = filters;
        this.sort = sort;
        this.options = options;
    }
    async query(queryType) {
        if (queryType === 'first-page' || queryType === 'recover-state') {
            this.nextPageConfiguration = undefined;
        }
        const prevChannels = queryType === 'recover-state' ? [] : this.channelService.channels;
        let filters;
        let options;
        if (this.nextPageConfiguration) {
            if (this.nextPageConfiguration.type === 'filter') {
                filters = {
                    ...this.filters,
                    ...this.nextPageConfiguration.paginationFilter,
                };
                options = this.options;
            }
            else {
                options = {
                    ...this.options,
                    offset: this.nextPageConfiguration.offset,
                };
                filters = this.filters;
            }
        }
        else {
            filters = this.filters;
            options = this.options;
        }
        const channels = await this.chatService.chatClient.queryChannels(filters, this.sort || {}, options);
        this.setNextPageConfiguration(channels);
        const currentActiveChannel = this.channelService.activeChannel;
        if (queryType === 'recover-state' &&
            currentActiveChannel &&
            !channels.find((c) => c.cid === currentActiveChannel?.cid)) {
            try {
                await currentActiveChannel.watch();
                channels.unshift(currentActiveChannel);
            }
            catch (error) {
                this.chatService.chatClient.logger('warn', 'Unable to refetch active channel after state recover', error);
            }
        }
        return {
            channels: [...prevChannels, ...channels],
            hasMorePage: channels.length >= this.options.limit,
        };
    }
    setNextPageConfiguration(channelQueryResult) {
        if (this.customPaginator) {
            this.nextPageConfiguration = this.customPaginator(channelQueryResult);
        }
        else {
            this.nextPageConfiguration = {
                type: 'offset',
                offset: (this.nextPageConfiguration?.type === 'offset'
                    ? this.nextPageConfiguration.offset
                    : 0) + channelQueryResult.length,
            };
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbm5lbC1xdWVyeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL3N0cmVhbS1jaGF0LWFuZ3VsYXIvc3JjL2xpYi9jaGFubmVsLXF1ZXJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWVBOztHQUVHO0FBQ0gsTUFBTSxPQUFPLFlBQVk7SUFhdkIsWUFDVSxXQUFpQyxFQUNqQyxjQUFpQyxFQUNqQyxPQUEwQixFQUMxQixPQUF1QixFQUFFLGVBQWUsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUM5QyxVQUEwQjtRQUNoQyxLQUFLLEVBQUUsRUFBRTtRQUNULEtBQUssRUFBRSxJQUFJO1FBQ1gsUUFBUSxFQUFFLElBQUk7UUFDZCxLQUFLLEVBQUUsSUFBSTtLQUNaO1FBVE8sZ0JBQVcsR0FBWCxXQUFXLENBQXNCO1FBQ2pDLG1CQUFjLEdBQWQsY0FBYyxDQUFtQjtRQUNqQyxZQUFPLEdBQVAsT0FBTyxDQUFtQjtRQUMxQixTQUFJLEdBQUosSUFBSSxDQUEwQztRQUM5QyxZQUFPLEdBQVAsT0FBTyxDQUtkO0lBQ0EsQ0FBQztJQUVKLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBMkI7UUFDckMsSUFBSSxTQUFTLEtBQUssWUFBWSxJQUFJLFNBQVMsS0FBSyxlQUFlLEVBQUU7WUFDL0QsSUFBSSxDQUFDLHFCQUFxQixHQUFHLFNBQVMsQ0FBQztTQUN4QztRQUNELE1BQU0sWUFBWSxHQUNoQixTQUFTLEtBQUssZUFBZSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDO1FBQ3BFLElBQUksT0FBMEIsQ0FBQztRQUMvQixJQUFJLE9BQXVCLENBQUM7UUFDNUIsSUFBSSxJQUFJLENBQUMscUJBQXFCLEVBQUU7WUFDOUIsSUFBSSxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTtnQkFDaEQsT0FBTyxHQUFHO29CQUNSLEdBQUcsSUFBSSxDQUFDLE9BQU87b0JBQ2YsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsZ0JBQWdCO2lCQUMvQyxDQUFDO2dCQUNGLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO2FBQ3hCO2lCQUFNO2dCQUNMLE9BQU8sR0FBRztvQkFDUixHQUFHLElBQUksQ0FBQyxPQUFPO29CQUNmLE1BQU0sRUFBRSxJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTTtpQkFDMUMsQ0FBQztnQkFDRixPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQzthQUN4QjtTQUNGO2FBQU07WUFDTCxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUN2QixPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztTQUN4QjtRQUNELE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUM5RCxPQUFPLEVBQ1AsSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFLEVBQ2YsT0FBTyxDQUNSLENBQUM7UUFDRixJQUFJLENBQUMsd0JBQXdCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFeEMsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQztRQUMvRCxJQUNFLFNBQVMsS0FBSyxlQUFlO1lBQzdCLG9CQUFvQjtZQUNwQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssb0JBQW9CLEVBQUUsR0FBRyxDQUFDLEVBQzFEO1lBQ0EsSUFBSTtnQkFDRixNQUFNLG9CQUFvQixDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNuQyxRQUFRLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7YUFDeEM7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDZCxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQ2hDLE1BQU0sRUFDTixzREFBc0QsRUFDdEQsS0FBZ0MsQ0FDakMsQ0FBQzthQUNIO1NBQ0Y7UUFFRCxPQUFPO1lBQ0wsUUFBUSxFQUFFLENBQUMsR0FBRyxZQUFZLEVBQUUsR0FBRyxRQUFRLENBQUM7WUFDeEMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFNO1NBQ3BELENBQUM7SUFDSixDQUFDO0lBRUQsd0JBQXdCLENBQUMsa0JBQWdDO1FBQ3ZELElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUN4QixJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1NBQ3ZFO2FBQU07WUFDTCxJQUFJLENBQUMscUJBQXFCLEdBQUc7Z0JBQzNCLElBQUksRUFBRSxRQUFRO2dCQUNkLE1BQU0sRUFDSixDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLEtBQUssUUFBUTtvQkFDNUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNO29CQUNuQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsa0JBQWtCLENBQUMsTUFBTTthQUNyQyxDQUFDO1NBQ0g7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFubmVsLFxuICBDaGFubmVsRmlsdGVycyxcbiAgQ2hhbm5lbE9wdGlvbnMsXG4gIENoYW5uZWxTb3J0LFxufSBmcm9tICdzdHJlYW0tY2hhdCc7XG5pbXBvcnQgeyBDaGFubmVsU2VydmljZSB9IGZyb20gJy4vY2hhbm5lbC5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIENoYW5uZWxRdWVyeVJlc3VsdCxcbiAgQ2hhbm5lbFF1ZXJ5VHlwZSxcbiAgRGVmYXVsdFN0cmVhbUNoYXRHZW5lcmljcyxcbiAgTmV4dFBhZ2VDb25maWd1cmF0aW9uLFxufSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IENoYXRDbGllbnRTZXJ2aWNlIH0gZnJvbSAnLi9jaGF0LWNsaWVudC5zZXJ2aWNlJztcblxuLyoqXG4gKiBUaGlzIGNsYXNzIGFsbG93cyB5b3UgdG8gbWFrZSBwYWdpbmF0ZWQgY2hhbm5lbCBxdWVyeSByZXF1ZXN0cy5cbiAqL1xuZXhwb3J0IGNsYXNzIENoYW5uZWxRdWVyeTxcbiAgVCBleHRlbmRzIERlZmF1bHRTdHJlYW1DaGF0R2VuZXJpY3MgPSBEZWZhdWx0U3RyZWFtQ2hhdEdlbmVyaWNzXG4+IHtcbiAgLyoqXG4gICAqIEJ5IGRlZmF1bHQgdGhlIFNESyB1c2VzIGFuIG9mZnNldCBiYXNlZCBwYWdpbmF0aW9uLCB5b3UgY2FuIGNoYW5nZS9leHRlbmQgdGhpcyBieSBwcm92aWRpbmcgeW91ciBvd24gY3VzdG9tIHBhZ2luYXRvciBtZXRob2QuXG4gICAqXG4gICAqIFRoZSBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgcmVzdWx0IG9mIHRoZSBsYXRlc3QgY2hhbm5lbCBxdWVyeS5cbiAgICpcbiAgICogWW91IGNhbiByZXR1cm4gZWl0aGVyIGFuIG9mZnNldCwgb3IgYSBmaWx0ZXIgdXNpbmcgdGhlIFtgJGx0ZWAvYCRndGVgIG9wZXJhdG9yXShodHRwczovL2dldHN0cmVhbS5pby9jaGF0L2RvY3MvamF2YXNjcmlwdC9xdWVyeV9zeW50YXhfb3BlcmF0b3JzLykuIElmIHlvdSByZXR1cm4gYSBmaWx0ZXIsIGl0IHdpbGwgYmUgbWVyZ2VkIHdpdGggdGhlIGZpbHRlciBwcm92aWRlZCBmb3IgdGhlIGBpbml0YCBtZXRob2QuXG4gICAqL1xuICBjdXN0b21QYWdpbmF0b3I/OiAoY2hhbm5lbFF1ZXJ5UmVzdWx0OiBDaGFubmVsPFQ+W10pID0+IE5leHRQYWdlQ29uZmlndXJhdGlvbjtcbiAgcHJpdmF0ZSBuZXh0UGFnZUNvbmZpZ3VyYXRpb24/OiBOZXh0UGFnZUNvbmZpZ3VyYXRpb247XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjaGF0U2VydmljZTogQ2hhdENsaWVudFNlcnZpY2U8VD4sXG4gICAgcHJpdmF0ZSBjaGFubmVsU2VydmljZTogQ2hhbm5lbFNlcnZpY2U8VD4sXG4gICAgcHJpdmF0ZSBmaWx0ZXJzOiBDaGFubmVsRmlsdGVyczxUPixcbiAgICBwcml2YXRlIHNvcnQ6IENoYW5uZWxTb3J0PFQ+ID0geyBsYXN0X21lc3NhZ2VfYXQ6IC0xIH0sXG4gICAgcHJpdmF0ZSBvcHRpb25zOiBDaGFubmVsT3B0aW9ucyA9IHtcbiAgICAgIGxpbWl0OiAyNSxcbiAgICAgIHN0YXRlOiB0cnVlLFxuICAgICAgcHJlc2VuY2U6IHRydWUsXG4gICAgICB3YXRjaDogdHJ1ZSxcbiAgICB9XG4gICkge31cblxuICBhc3luYyBxdWVyeShxdWVyeVR5cGU6IENoYW5uZWxRdWVyeVR5cGUpOiBQcm9taXNlPENoYW5uZWxRdWVyeVJlc3VsdDxUPj4ge1xuICAgIGlmIChxdWVyeVR5cGUgPT09ICdmaXJzdC1wYWdlJyB8fCBxdWVyeVR5cGUgPT09ICdyZWNvdmVyLXN0YXRlJykge1xuICAgICAgdGhpcy5uZXh0UGFnZUNvbmZpZ3VyYXRpb24gPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGNvbnN0IHByZXZDaGFubmVscyA9XG4gICAgICBxdWVyeVR5cGUgPT09ICdyZWNvdmVyLXN0YXRlJyA/IFtdIDogdGhpcy5jaGFubmVsU2VydmljZS5jaGFubmVscztcbiAgICBsZXQgZmlsdGVyczogQ2hhbm5lbEZpbHRlcnM8VD47XG4gICAgbGV0IG9wdGlvbnM6IENoYW5uZWxPcHRpb25zO1xuICAgIGlmICh0aGlzLm5leHRQYWdlQ29uZmlndXJhdGlvbikge1xuICAgICAgaWYgKHRoaXMubmV4dFBhZ2VDb25maWd1cmF0aW9uLnR5cGUgPT09ICdmaWx0ZXInKSB7XG4gICAgICAgIGZpbHRlcnMgPSB7XG4gICAgICAgICAgLi4udGhpcy5maWx0ZXJzLFxuICAgICAgICAgIC4uLnRoaXMubmV4dFBhZ2VDb25maWd1cmF0aW9uLnBhZ2luYXRpb25GaWx0ZXIsXG4gICAgICAgIH07XG4gICAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgIC4uLnRoaXMub3B0aW9ucyxcbiAgICAgICAgICBvZmZzZXQ6IHRoaXMubmV4dFBhZ2VDb25maWd1cmF0aW9uLm9mZnNldCxcbiAgICAgICAgfTtcbiAgICAgICAgZmlsdGVycyA9IHRoaXMuZmlsdGVycztcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZmlsdGVycyA9IHRoaXMuZmlsdGVycztcbiAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7XG4gICAgfVxuICAgIGNvbnN0IGNoYW5uZWxzID0gYXdhaXQgdGhpcy5jaGF0U2VydmljZS5jaGF0Q2xpZW50LnF1ZXJ5Q2hhbm5lbHMoXG4gICAgICBmaWx0ZXJzLFxuICAgICAgdGhpcy5zb3J0IHx8IHt9LFxuICAgICAgb3B0aW9uc1xuICAgICk7XG4gICAgdGhpcy5zZXROZXh0UGFnZUNvbmZpZ3VyYXRpb24oY2hhbm5lbHMpO1xuXG4gICAgY29uc3QgY3VycmVudEFjdGl2ZUNoYW5uZWwgPSB0aGlzLmNoYW5uZWxTZXJ2aWNlLmFjdGl2ZUNoYW5uZWw7XG4gICAgaWYgKFxuICAgICAgcXVlcnlUeXBlID09PSAncmVjb3Zlci1zdGF0ZScgJiZcbiAgICAgIGN1cnJlbnRBY3RpdmVDaGFubmVsICYmXG4gICAgICAhY2hhbm5lbHMuZmluZCgoYykgPT4gYy5jaWQgPT09IGN1cnJlbnRBY3RpdmVDaGFubmVsPy5jaWQpXG4gICAgKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBjdXJyZW50QWN0aXZlQ2hhbm5lbC53YXRjaCgpO1xuICAgICAgICBjaGFubmVscy51bnNoaWZ0KGN1cnJlbnRBY3RpdmVDaGFubmVsKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMuY2hhdFNlcnZpY2UuY2hhdENsaWVudC5sb2dnZXIoXG4gICAgICAgICAgJ3dhcm4nLFxuICAgICAgICAgICdVbmFibGUgdG8gcmVmZXRjaCBhY3RpdmUgY2hhbm5lbCBhZnRlciBzdGF0ZSByZWNvdmVyJyxcbiAgICAgICAgICBlcnJvciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPlxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBjaGFubmVsczogWy4uLnByZXZDaGFubmVscywgLi4uY2hhbm5lbHNdLFxuICAgICAgaGFzTW9yZVBhZ2U6IGNoYW5uZWxzLmxlbmd0aCA+PSB0aGlzLm9wdGlvbnMubGltaXQhLFxuICAgIH07XG4gIH1cblxuICBzZXROZXh0UGFnZUNvbmZpZ3VyYXRpb24oY2hhbm5lbFF1ZXJ5UmVzdWx0OiBDaGFubmVsPFQ+W10pIHtcbiAgICBpZiAodGhpcy5jdXN0b21QYWdpbmF0b3IpIHtcbiAgICAgIHRoaXMubmV4dFBhZ2VDb25maWd1cmF0aW9uID0gdGhpcy5jdXN0b21QYWdpbmF0b3IoY2hhbm5lbFF1ZXJ5UmVzdWx0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5uZXh0UGFnZUNvbmZpZ3VyYXRpb24gPSB7XG4gICAgICAgIHR5cGU6ICdvZmZzZXQnLFxuICAgICAgICBvZmZzZXQ6XG4gICAgICAgICAgKHRoaXMubmV4dFBhZ2VDb25maWd1cmF0aW9uPy50eXBlID09PSAnb2Zmc2V0J1xuICAgICAgICAgICAgPyB0aGlzLm5leHRQYWdlQ29uZmlndXJhdGlvbi5vZmZzZXRcbiAgICAgICAgICAgIDogMCkgKyBjaGFubmVsUXVlcnlSZXN1bHQubGVuZ3RoLFxuICAgICAgfTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==